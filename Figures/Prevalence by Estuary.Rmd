---
title: "Prevalence by estuary"
author: "Joshua Tu"
date: "2025-10-08"
output: html_document
---

library(readxl)
library(dplyr)
library(ggplot2)
library(scales)
library(ggpubr)
library(rstatix)
library(emmeans)

# Load data
df <- read_excel("/Users/joshuatu/Desktop/Honours/All Data.xlsx", sheet = "All Data")

# Define positivity
is_pos <- function(ct) is.finite(ct) & ct <= 40

# Calculate sample-level positivity (any replicate positive = sample positive)
d_est <- df %>%
  filter(tolower(Gene) == "tlh") %>%
  transmute(Sample, Estuary = Location, CT = suppressWarnings(as.numeric(CT))) %>%
  mutate(pos = is_pos(CT)) %>%
  group_by(Estuary, Sample) %>%
  summarise(pos = any(pos, na.rm = TRUE), .groups = "drop")

# Calculate prevalence with 95% CI
prev <- d_est %>%
  group_by(Estuary) %>%
  summarise(n = n(), k = sum(pos), .groups = "drop") %>%
  rowwise() %>%
  mutate(prev = k/n, ci = list(prop.test(k, n)$conf.int), lo = ci[1], hi = ci[2]) %>%
  ungroup() %>% select(-ci)

# Statistical analysis: GLM with Tukey post-hoc
model <- glm(pos ~ Estuary, data = d_est, family = binomial)
print(anova(glm(pos ~ 1, data = d_est, family = binomial), model, test = "LRT"))

# Get pairwise comparisons using emmeans
pairs_emm <- pairs(emmeans(model, ~ Estuary), adjust = "tukey")
print(pairs_emm)

# Convert to dataframe and format for stat_pvalue_manual
pairs_df <- as.data.frame(pairs_emm) %>%
  mutate(
    # Split the contrast on " - " to get group names
    group1 = trimws(sub(" -.*", "", contrast)),
    group2 = trimws(sub(".*- ", "", contrast)),
    # Format p-value labels
    p.adj.signif = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  filter(p.value < 0.05) %>%  # Only keep significant comparisons
  select(group1, group2, p.adj = p.value, p.adj.signif)

# Print to verify
cat("\n\nSignificant comparisons found:\n")
print(pairs_df)

# Prepare plotting data - ordered by prevalence
prev_plot <- prev %>%
  arrange(prev) %>%
  mutate(Estuary = factor(Estuary, levels = Estuary))

# Create color palette
pal <- setNames(hue_pal()(nrow(prev_plot)), levels(prev_plot$Estuary))

# Base plot
p <- ggplot(prev_plot, aes(x = Estuary, y = prev, fill = Estuary)) +
  geom_col(width = 0.7, alpha = 0.8) +
  geom_errorbar(aes(ymin = lo, ymax = hi), width = 0.15, linewidth = 0.7) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1), 
    limits = c(0, 1.3),  # Increased to 130%
    expand = expansion(mult = c(0, 0))
  ) +
  scale_fill_manual(values = pal, guide = "none") +
  labs(x = "Estuary", y = "% positive (95% CI)") +
  theme_classic(base_size = 12) +
  theme(
    axis.text.x = element_text(size = 10)
  )

# Add significance brackets - ALL 3 with better positioning
if (nrow(pairs_df) > 0) {
  max_y <- max(prev_plot$hi)
  
  pairs_df <- pairs_df %>%
    arrange(desc(p.adj)) %>%  # Most significant (lowest p) on top
    mutate(
      y.position = max_y + 0.1 + (row_number() - 1) * 0.1  # More spacing between brackets
    )
  
  p <- p + 
    stat_pvalue_manual(
      pairs_df,
      label = "p.adj.signif",
      tip.length = 0.02,
      hide.ns = TRUE,
      size = 4,
      bracket.size = 0.5
    )
}

p
